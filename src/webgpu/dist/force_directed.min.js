"use strict";var __awaiter=this&&this.__awaiter||function(e,o,s,u){return new(s=s||Promise)(function(t,i){function r(e){try{n(u.next(e))}catch(e){i(e)}}function a(e){try{n(u.throw(e))}catch(e){i(e)}}function n(e){e.done?t(e.value):function(t){return t instanceof s?t:new s(function(e){e(t)})}(e.value).then(r,a)}n((u=u.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(i,r){var a,n,o,e,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;s;)try{if(a=1,n&&(o=2&t[0]?n.return:t[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,t[1])).done)return o;switch(n=0,o&&(t=[2&t[0],o.value]),t[0]){case 0:case 1:o=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,n=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(o=0<(o=s.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){s.label=t[1];break}if(6===t[0]&&s.label<o[1]){s.label=o[1],o=t;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(t);break}o[2]&&s.ops.pop(),s.trys.pop();continue}t=r.call(i,s)}catch(e){t=[6,e],n=0}finally{a=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};exports.__esModule=!0;var wgsl_1=require("./wgsl"),ForceDirected=function(){function e(e){this.coolingFactor=.9,this.iterationCount=1e4,this.threshold=100,this.force=1e3,this.device=e,this.nodeDataBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.edgeDataBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.adjMatrixBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.forceDataBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),this.treeBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.uniformParamterBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.createAdjMatrixPipeline=e.createComputePipeline({compute:{module:e.createShaderModule({code:wgsl_1.create_adjacency_matrix}),entryPoint:"main"}}),this.bindGroupLayoutTree=e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]}),this.treePipelineLayout=this.device.createPipelineLayout({bindGroupLayouts:[this.bindGroupLayoutTree]}),this.computeTreePipeline=e.createComputePipeline({layout:this.treePipelineLayout,compute:{module:e.createShaderModule({code:wgsl_1.buildTree}),entryPoint:"main"}}),this.computeForcesPipeline=e.createComputePipeline({compute:{module:e.createShaderModule({code:wgsl_1.compute_forces_combined}),entryPoint:"main"}}),this.computeAttractForcesPipeline=e.createComputePipeline({compute:{module:e.createShaderModule({code:wgsl_1.compute_forces_a}),entryPoint:"main"},layout:e.createPipelineLayout({bindGroupLayouts:[e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]})]})}),this.applyForcesPipeline=e.createComputePipeline({compute:{module:e.createShaderModule({code:wgsl_1.apply_forces}),entryPoint:"main"}}),this.paramsBuffer=e.createBuffer({size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST})}return e.prototype.runForces=function(P,B,b,y,m,U,G,v,S){return void 0===P&&(P=this.nodeDataBuffer),void 0===B&&(B=this.edgeDataBuffer),void 0===b&&(b=0),void 0===y&&(y=0),void 0===m&&(m=this.coolingFactor),void 0===U&&(U=.05),void 0===G&&(G=this.iterationCount),void 0===v&&(v=this.threshold),__awaiter(this,void 0,void 0,function(){var t,i,r,a,n,o,s,u,f,c,d,h,p,l,g;return __generator(this,function(e){switch(e.label){case 0:if(0==b||0==y)return[2];console.log(U),console.log(m),this.coolingFactor=m,this.nodeDataBuffer=P,this.edgeDataBuffer=B,this.threshold=v,this.force=1e5,n=this.device.createBuffer({size:16,usage:GPUBufferUsage.COPY_SRC,mappedAtCreation:!0}),o=n.getMappedRange(),new Uint32Array(o).set([b,y]),new Float32Array(o).set([this.coolingFactor,U],2),n.unmap(),this.adjMatrixBuffer=this.device.createBuffer({size:b*b*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),this.treeBuffer=this.device.createBuffer({size:16*b,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),(s=this.device.createCommandEncoder()).copyBufferToBuffer(n,0,this.paramsBuffer,0,16),t=this.device.createBindGroup({layout:this.createAdjMatrixPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.edgeDataBuffer}},{binding:1,resource:{buffer:this.adjMatrixBuffer}},{binding:2,resource:{buffer:this.paramsBuffer}}]}),(d=s.beginComputePass()).setBindGroup(0,t),d.setPipeline(this.createAdjMatrixPipeline),d.dispatch(1,1,1),d.endPass(),this.device.queue.submit([s.finish()]),this.forceDataBuffer=this.device.createBuffer({size:2*b*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),i=[],r=performance.now(),a=this.device.createBindGroup({layout:this.applyForcesPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.nodeDataBuffer}},{binding:1,resource:{buffer:this.forceDataBuffer}}]}),e.label=1;case 1:return 0<G&&1e-6<this.coolingFactor&&0<=this.force?(G--,n=this.device.createBuffer({size:16,usage:GPUBufferUsage.COPY_SRC,mappedAtCreation:!0}),o=n.getMappedRange(),new Uint32Array(o).set([b,y]),new Float32Array(o).set([this.coolingFactor,U],2),n.unmap(),(s=this.device.createCommandEncoder()).copyBufferToBuffer(n,0,this.paramsBuffer,0,16),u=this.device.createBindGroup({layout:this.bindGroupLayoutTree,entries:[{binding:0,resource:{buffer:this.nodeDataBuffer}},{binding:1,resource:{buffer:this.treeBuffer}},{binding:2,resource:{buffer:this.uniformParamterBuffer}}]}),f=this.device.createBindGroup({layout:this.computeForcesPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.nodeDataBuffer}},{binding:1,resource:{buffer:this.adjMatrixBuffer}},{binding:2,resource:{buffer:this.forceDataBuffer}},{binding:3,resource:{buffer:this.paramsBuffer}}]}),this.device.createBindGroup({layout:this.computeAttractForcesPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.nodeDataBuffer}},{binding:1,resource:{buffer:this.edgeDataBuffer}},{binding:2,resource:{buffer:this.forceDataBuffer}},{binding:3,resource:{buffer:this.paramsBuffer}}]}),(c=s.beginComputePass()).setPipeline(this.computeTreePipeline),c.setBindGroup(0,u),d.dispatch(b,1,1),c.endPass(),(d=s.beginComputePass()).setBindGroup(0,f),d.setPipeline(this.computeForcesPipeline),d.dispatch(b,1,1),d.endPass(),(d=s.beginComputePass()).setBindGroup(0,a),d.setPipeline(this.applyForcesPipeline),d.dispatch(b,1,1),d.endPass(),this.device.queue.submit([s.finish()]),h=performance.now(),[4,this.device.queue.onSubmittedWorkDone()]):[3,3];case 2:return e.sent(),p=performance.now(),console.log("iteration time "+(p-h)),i.push(p-h),this.coolingFactor=this.coolingFactor*m,[3,1];case 3:return l=performance.now(),g=i.reduce(function(e,t){return e+t})/i.length,S.current.innerText="Completed in "+i.length+" iterations with total time "+(l-r)+" and average iteration time "+g,[2]}})})},e}();exports.default=ForceDirected;
//# sourceMappingURL=force_directed.min.js.map
