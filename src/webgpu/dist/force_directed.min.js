"use strict";var __awaiter=this&&this.__awaiter||function(e,n,u,o){return new(u=u||Promise)(function(t,r){function i(e){try{s(o.next(e))}catch(e){r(e)}}function a(e){try{s(o.throw(e))}catch(e){r(e)}}function s(e){e.done?t(e.value):function(t){return t instanceof u?t:new u(function(e){e(t)})}(e.value).then(i,a)}s((o=o.apply(e,n||[])).next())})},__generator=this&&this.__generator||function(r,i){var a,s,n,e,u={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;u;)try{if(a=1,s&&(n=2&t[0]?s.return:t[0]?s.throw||((n=s.return)&&n.call(s),0):s.next)&&!(n=n.call(s,t[1])).done)return n;switch(s=0,n&&(t=[2&t[0],n.value]),t[0]){case 0:case 1:n=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,s=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(n=0<(n=u.trys).length&&n[n.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!n||t[1]>n[0]&&t[1]<n[3])){u.label=t[1];break}if(6===t[0]&&u.label<n[1]){u.label=n[1],n=t;break}if(n&&u.label<n[2]){u.label=n[2],u.ops.push(t);break}n[2]&&u.ops.pop(),u.trys.pop();continue}t=i.call(r,u)}catch(e){t=[6,e],s=0}finally{a=n=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};exports.__esModule=!0;var wgsl_1=require("./wgsl"),ForceDirected=function(){function e(e){this.coolingFactor=.9,this.iterationCount=1e4,this.threshold=100,this.force=1e3,this.device=e,this.nodeDataBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.edgeDataBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.adjMatrixBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.forceDataBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),this.treeBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),this.lastIndexBuffer=this.device.createBuffer({size:4,mappedAtCreation:!0,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),new Uint32Array(this.lastIndexBuffer.getMappedRange()).set([0]),this.lastIndexBuffer.unmap(),this.uniformParameterBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.createAdjMatrixPipeline=e.createComputePipeline({compute:{module:e.createShaderModule({code:wgsl_1.create_adjacency_matrix}),entryPoint:"main"}}),this.bindGroupLayoutTree=e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}]}),this.treePipelineLayout=this.device.createPipelineLayout({bindGroupLayouts:[this.bindGroupLayoutTree]}),this.computeTreePipeline=e.createComputePipeline({layout:this.treePipelineLayout,compute:{module:e.createShaderModule({code:wgsl_1.buildTree}),entryPoint:"main"}}),this.computeForcesPipeline=e.createComputePipeline({compute:{module:e.createShaderModule({code:wgsl_1.compute_forces_combined}),entryPoint:"main"}}),this.computeAttractForcesPipeline=e.createComputePipeline({compute:{module:e.createShaderModule({code:wgsl_1.compute_forces_a}),entryPoint:"main"},layout:e.createPipelineLayout({bindGroupLayouts:[e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]})]})}),this.applyForcesPipeline=e.createComputePipeline({compute:{module:e.createShaderModule({code:wgsl_1.apply_forces}),entryPoint:"main"}}),this.paramsBuffer=e.createBuffer({size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST})}return e.prototype.runForces=function(b,U,m,y,G,v,C,S,_){return void 0===b&&(b=this.nodeDataBuffer),void 0===U&&(U=this.edgeDataBuffer),void 0===m&&(m=0),void 0===y&&(y=0),void 0===G&&(G=this.coolingFactor),void 0===v&&(v=.05),void 0===C&&(C=this.iterationCount),void 0===S&&(S=this.threshold),__awaiter(this,void 0,void 0,function(){var t,r,i,a,s,n,u,o,f,c,d,h,p,l,g,B,P;return __generator(this,function(e){switch(e.label){case 0:if(0==m||0==y)return[2];console.log(v),console.log(G),this.coolingFactor=G,this.nodeDataBuffer=b,this.edgeDataBuffer=U,this.threshold=S,this.force=1e5,f=this.device.createBuffer({size:16,usage:GPUBufferUsage.COPY_SRC,mappedAtCreation:!0}),c=f.getMappedRange(),new Uint32Array(c).set([m,y]),new Float32Array(c).set([this.coolingFactor,v],2),f.unmap(),this.adjMatrixBuffer=this.device.createBuffer({size:m*m*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),this.treeBuffer=this.device.createBuffer({size:4*(m+1)*16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),this.uniformParameterBuffer=this.device.createBuffer({size:8,usage:GPUBufferUsage.UNIFORM,mappedAtCreation:!0}),t=this.uniformParameterBuffer.getMappedRange(),new Uint8Array(t).set([m]),new Float32Array(t).set([.5],1),(d=this.device.createCommandEncoder()).copyBufferToBuffer(f,0,this.paramsBuffer,0,16),r=this.device.createBindGroup({layout:this.createAdjMatrixPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.edgeDataBuffer}},{binding:1,resource:{buffer:this.adjMatrixBuffer}},{binding:2,resource:{buffer:this.paramsBuffer}}]}),(p=d.beginComputePass()).setBindGroup(0,r),p.setPipeline(this.createAdjMatrixPipeline),p.dispatch(1,1,1),p.endPass(),this.device.queue.submit([d.finish()]),this.forceDataBuffer=this.device.createBuffer({size:2*m*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),i=[],a=performance.now(),s=this.device.createBindGroup({layout:this.applyForcesPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.nodeDataBuffer}},{binding:1,resource:{buffer:this.forceDataBuffer}}]}),n=this.device.createBindGroup({layout:this.bindGroupLayoutTree,entries:[{binding:0,resource:{buffer:this.nodeDataBuffer}},{binding:1,resource:{buffer:this.treeBuffer}},{binding:2,resource:{buffer:this.uniformParameterBuffer}},{binding:3,resource:{buffer:this.lastIndexBuffer}}]}),(u=d.beginComputePass()).setPipeline(this.computeTreePipeline),u.setBindGroup(0,n),u.dispatch(m,1,1),u.endPass(),o=this.device.createBuffer({size:16*m,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),d.copyBufferToBuffer(this.treeBuffer,0,o,0,6*m),e.label=1;case 1:return 0<C&&1e-6<this.coolingFactor&&0<=this.force?(C--,f=this.device.createBuffer({size:16,usage:GPUBufferUsage.COPY_SRC,mappedAtCreation:!0}),c=f.getMappedRange(),new Uint32Array(c).set([m,y]),new Float32Array(c).set([this.coolingFactor,v],2),f.unmap(),(d=this.device.createCommandEncoder()).copyBufferToBuffer(f,0,this.paramsBuffer,0,16),h=this.device.createBindGroup({layout:this.computeForcesPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.nodeDataBuffer}},{binding:1,resource:{buffer:this.adjMatrixBuffer}},{binding:2,resource:{buffer:this.forceDataBuffer}},{binding:3,resource:{buffer:this.paramsBuffer}}]}),this.device.createBindGroup({layout:this.computeAttractForcesPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.nodeDataBuffer}},{binding:1,resource:{buffer:this.edgeDataBuffer}},{binding:2,resource:{buffer:this.forceDataBuffer}},{binding:3,resource:{buffer:this.paramsBuffer}}]}),(p=d.beginComputePass()).setBindGroup(0,h),p.setPipeline(this.computeForcesPipeline),p.dispatch(m,1,1),p.endPass(),(p=d.beginComputePass()).setBindGroup(0,s),p.setPipeline(this.applyForcesPipeline),p.dispatch(m,1,1),p.endPass(),this.device.queue.submit([d.finish()]),l=performance.now(),[4,this.device.queue.onSubmittedWorkDone()]):[3,3];case 2:return e.sent(),g=performance.now(),console.log("iteration time "+(g-l)),i.push(g-l),this.coolingFactor=this.coolingFactor*G,[3,1];case 3:return B=performance.now(),P=i.reduce(function(e,t){return e+t})/i.length,_.current.innerText="Completed in "+i.length+" iterations with total time "+(B-a)+" and average iteration time "+P,[2]}})})},e}();exports.default=ForceDirected;
//# sourceMappingURL=force_directed.min.js.map
