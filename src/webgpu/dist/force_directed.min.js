"use strict";var __awaiter=this&&this.__awaiter||function(e,n,u,o){return new(u=u||Promise)(function(t,r){function i(e){try{s(o.next(e))}catch(e){r(e)}}function a(e){try{s(o.throw(e))}catch(e){r(e)}}function s(e){e.done?t(e.value):function(t){return t instanceof u?t:new u(function(e){e(t)})}(e.value).then(i,a)}s((o=o.apply(e,n||[])).next())})},__generator=this&&this.__generator||function(r,i){var a,s,n,e,u={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;u;)try{if(a=1,s&&(n=2&t[0]?s.return:t[0]?s.throw||((n=s.return)&&n.call(s),0):s.next)&&!(n=n.call(s,t[1])).done)return n;switch(s=0,n&&(t=[2&t[0],n.value]),t[0]){case 0:case 1:n=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,s=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(n=0<(n=u.trys).length&&n[n.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!n||t[1]>n[0]&&t[1]<n[3])){u.label=t[1];break}if(6===t[0]&&u.label<n[1]){u.label=n[1],n=t;break}if(n&&u.label<n[2]){u.label=n[2],u.ops.push(t);break}n[2]&&u.ops.pop(),u.trys.pop();continue}t=i.call(r,u)}catch(e){t=[6,e],s=0}finally{a=n=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};exports.__esModule=!0;var wgsl_1=require("./wgsl"),ForceDirected=function(){function e(e){this.coolingFactor=.9,this.iterationCount=1e4,this.threshold=100,this.force=1e3,this.device=e,this.nodeDataBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.edgeDataBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.adjMatrixBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.forceDataBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),this.treeBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),this.lastIndexBuffer=this.device.createBuffer({size:4,mappedAtCreation:!0,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),new Int32Array(this.lastIndexBuffer.getMappedRange()).set([0]),this.lastIndexBuffer.unmap(),this.uniformParameterBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.createAdjMatrixPipeline=e.createComputePipeline({compute:{module:e.createShaderModule({code:wgsl_1.create_adjacency_matrix}),entryPoint:"main"}}),this.bindGroupLayoutTree=e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}]}),this.treePipelineLayout=this.device.createPipelineLayout({bindGroupLayouts:[this.bindGroupLayoutTree]}),this.computeTreePipeline=e.createComputePipeline({layout:this.treePipelineLayout,compute:{module:e.createShaderModule({code:wgsl_1.buildTree}),entryPoint:"main"}}),this.computeForcesPipeline=e.createComputePipeline({compute:{module:e.createShaderModule({code:wgsl_1.compute_forces_combined}),entryPoint:"main"}}),this.computeAttractForcesPipeline=e.createComputePipeline({compute:{module:e.createShaderModule({code:wgsl_1.compute_forces_a}),entryPoint:"main"},layout:e.createPipelineLayout({bindGroupLayouts:[e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]})]})}),this.applyForcesPipeline=e.createComputePipeline({compute:{module:e.createShaderModule({code:wgsl_1.apply_forces}),entryPoint:"main"}}),this.paramsBuffer=e.createBuffer({size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST})}return e.prototype.runForces=function(y,U,G,v,C,S,_,w,O){return void 0===y&&(y=this.nodeDataBuffer),void 0===U&&(U=this.edgeDataBuffer),void 0===G&&(G=0),void 0===v&&(v=0),void 0===C&&(C=this.coolingFactor),void 0===S&&(S=.05),void 0===_&&(_=this.iterationCount),void 0===w&&(w=this.threshold),__awaiter(this,void 0,void 0,function(){var t,r,i,a,s,n,u,o,f,c,d,h,p,l,g,P,B,b,m;return __generator(this,function(e){switch(e.label){case 0:return 0==G||0==v?[2]:(console.log(S),console.log(C),this.coolingFactor=C,this.nodeDataBuffer=y,this.edgeDataBuffer=U,this.threshold=w,this.force=1e5,d=this.device.createBuffer({size:16,usage:GPUBufferUsage.COPY_SRC,mappedAtCreation:!0}),h=d.getMappedRange(),new Uint32Array(h).set([G,v]),new Float32Array(h).set([this.coolingFactor,S],2),d.unmap(),this.adjMatrixBuffer=this.device.createBuffer({size:G*G*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),this.treeBuffer=this.device.createBuffer({size:4*(G+1)*12*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),this.uniformParameterBuffer=this.device.createBuffer({size:8,usage:GPUBufferUsage.UNIFORM,mappedAtCreation:!0}),t=this.uniformParameterBuffer.getMappedRange(),new Uint8Array(t).set([G]),new Float32Array(t).set([.5],1),(p=this.device.createCommandEncoder()).copyBufferToBuffer(d,0,this.paramsBuffer,0,16),r=this.device.createBindGroup({layout:this.createAdjMatrixPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.edgeDataBuffer}},{binding:1,resource:{buffer:this.adjMatrixBuffer}},{binding:2,resource:{buffer:this.paramsBuffer}}]}),(g=p.beginComputePass()).setBindGroup(0,r),g.setPipeline(this.createAdjMatrixPipeline),g.dispatch(1,1,1),g.endPass(),this.device.queue.submit([p.finish()]),this.forceDataBuffer=this.device.createBuffer({size:2*G*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),i=[],a=performance.now(),s=this.device.createBindGroup({layout:this.applyForcesPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.nodeDataBuffer}},{binding:1,resource:{buffer:this.forceDataBuffer}}]}),n=this.device.createBindGroup({layout:this.bindGroupLayoutTree,entries:[{binding:0,resource:{buffer:this.nodeDataBuffer}},{binding:1,resource:{buffer:this.treeBuffer}},{binding:2,resource:{buffer:this.uniformParameterBuffer}},{binding:3,resource:{buffer:this.lastIndexBuffer}}]}),(u=p.beginComputePass()).setPipeline(this.computeTreePipeline),u.setBindGroup(0,n),u.dispatch(G,1,1),u.endPass(),o=this.device.createBuffer({size:4*(G+1)*12*4,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),p.copyBufferToBuffer(this.treeBuffer,0,o,0,6*G),[4,o.mapAsync(GPUMapMode.READ)]);case 1:e.sent(),f=o.getMappedRange(),c=new Float32Array(f),o.unmap(),console.log(c),e.label=2;case 2:return 0<_&&1e-6<this.coolingFactor&&0<=this.force?(_--,d=this.device.createBuffer({size:16,usage:GPUBufferUsage.COPY_SRC,mappedAtCreation:!0}),h=d.getMappedRange(),new Uint32Array(h).set([G,v]),new Float32Array(h).set([this.coolingFactor,S],2),d.unmap(),(p=this.device.createCommandEncoder()).copyBufferToBuffer(d,0,this.paramsBuffer,0,16),l=this.device.createBindGroup({layout:this.computeForcesPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.nodeDataBuffer}},{binding:1,resource:{buffer:this.adjMatrixBuffer}},{binding:2,resource:{buffer:this.forceDataBuffer}},{binding:3,resource:{buffer:this.paramsBuffer}}]}),this.device.createBindGroup({layout:this.computeAttractForcesPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.nodeDataBuffer}},{binding:1,resource:{buffer:this.edgeDataBuffer}},{binding:2,resource:{buffer:this.forceDataBuffer}},{binding:3,resource:{buffer:this.paramsBuffer}}]}),(g=p.beginComputePass()).setBindGroup(0,l),g.setPipeline(this.computeForcesPipeline),g.dispatch(G,1,1),g.endPass(),(g=p.beginComputePass()).setBindGroup(0,s),g.setPipeline(this.applyForcesPipeline),g.dispatch(G,1,1),g.endPass(),this.device.queue.submit([p.finish()]),P=performance.now(),[4,this.device.queue.onSubmittedWorkDone()]):[3,4];case 3:return e.sent(),B=performance.now(),console.log("iteration time "+(B-P)),i.push(B-P),this.coolingFactor=this.coolingFactor*C,[3,2];case 4:return b=performance.now(),m=i.reduce(function(e,t){return e+t})/i.length,O.current.innerText="Completed in "+i.length+" iterations with total time "+(b-a)+" and average iteration time "+m,[2]}})})},e}();exports.default=ForceDirected;
//# sourceMappingURL=force_directed.min.js.map
